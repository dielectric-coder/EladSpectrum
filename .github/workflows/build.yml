name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-ubuntu:
    name: Build (Ubuntu x86_64)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-4-dev libusb-1.0-0-dev libfftw3-dev meson ninja-build

      - name: Configure
        run: meson setup build

      - name: Build
        run: meson compile -C build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: elad-spectrum-ubuntu-x86_64
          path: build/elad-spectrum

  build-pi:
    name: Build (Raspberry Pi ARM64)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build in ARM64 container
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: bookworm
          githubToken: ${{ github.token }}
          install: |
            apt-get update
            apt-get install -y libgtk-4-dev libusb-1.0-0-dev libfftw3-dev meson ninja-build
          run: |
            meson setup build
            meson compile -C build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: elad-spectrum-pi-arm64
          path: build/elad-spectrum
